# Recreate a robust patch that doesn't depend on pattern matching and appends a new init script.
from pathlib import Path
import re

src_path = Path('/mnt/data/GO-ALIVE-MEDIA-Phase1.8.0.html')
html = src_path.read_text(encoding='utf-8', errors='ignore')

# 1) Add Sign out button near userBadge if not present
if 'id="btnSignOut"' not in html:
    html = html.replace(
        '<span class="badge" id="userBadge">—</span>',
        '<span class="badge" id="userBadge">—</span><button id="btnSignOut" class="btn btn-danger" style="display:none">Sign out</button>'
    )

# 2) Insert login overlay after header
if 'id="loginOverlay"' not in html:
    insert_after = html.find('</header>')
    login_markup = """
<!-- Login Overlay -->
<div id="loginOverlay" class="hidden" style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(15,23,42,.65);backdrop-filter:blur(4px);z-index:1000">
  <form id="loginForm" class="card" style="width:360px;padding:16px">
    <div style="font-size:18px;font-weight:800;margin-bottom:8px">Sign in</div>
    <div class="muted" style="font-size:12px;margin-bottom:12px">Enter your email and password</div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div><label>Email</label><input id="loginEmail" type="email" required placeholder="you@goalive.local"></div>
      <div><label>Password</label><input id="loginPassword" type="password" required placeholder="••••••••"></div>
      <div id="loginError" class="hidden" style="color:#b91c1c;font-size:12px"></div>
      <button class="btn btn-primary" type="submit">Sign in</button>
    </div>
    <div class="muted" style="margin-top:10px;font-size:12px">Tip: Admin demo — admin@goalive.local / admin123</div>
  </form>
</div>
"""
    if insert_after != -1:
        html = html[:insert_after+len('</header>')] + login_markup + html[insert_after+len('</header>'):]

# 3) Remove the hardcoded auto session if present
html = html.replace("applySession({ email:'admin@goalive.local', name:'Ava Admin', role:'Admin' });", "// disabled auto session")

# 4) Enhance user creation to add tempPassword if not yet done
m = re.search(r"\$\('userForm'\)\.onsubmit=function\(e\)\{.*?\};", html, flags=re.S)
if m and 'tempPassword' not in m.group(0):
    patched = m.group(0).replace(
        "var u={ id: nextUserId(), name:name, email:email, role:role, active:true, lastLogin:null, createdAt:new Date().toISOString() };",
        "var temp = Math.random().toString(36).slice(-8);\n    var u={ id: nextUserId(), name:name, email:email, role:role, active:true, tempPassword:temp, lastLogin:null, createdAt:new Date().toISOString() };"
    ).replace(
        "toast('User added');",
        "toast('User added — temp password: '+temp); alert('User '+email+' temporary password: '+temp);"
    )
    html = html[:m.start()] + patched + html[m.end():]

# 5) Append a new init script that wires login, regardless of prior code
if 'GOALIVE_LOGIN_INIT' not in html:
    init_script = """
<script id="GOALIVE_LOGIN_INIT">
(function(){
  function defaultLanding(role){
    role = (role||'Admin').toLowerCase();
    if(role==='admin') return 'panel-admin';
    if(role==='sales') return 'panel-dashboard-sales';
    if(role==='rj') return 'panel-winners';
    return 'panel-collections';
  }
  function show(id){ var el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
  function hide(id){ var el=document.getElementById(id); if(el) el.classList.add('hidden'); }

  // Seed demo admin password if missing
  try{
    var users = (function(){ try{ return JSON.parse(localStorage.getItem('ga_users')||'null'); }catch(e){ return null; } })();
    if(Array.isArray(users)){
      var i = users.findIndex(function(u){ return (u.email||'').toLowerCase()==='admin@goalive.local'; });
      if(i!==-1 && !users[i].password && !users[i].tempPassword){
        users[i].password='admin123';
        localStorage.setItem('ga_users', JSON.stringify(users));
      }
    }
  }catch(e){}

  // Sign out button
  var btnSO = document.getElementById('btnSignOut');
  if(btnSO){
    btnSO.onclick = function(){
      try{ localStorage.removeItem('ga_session'); }catch(e){}
      hide('panel-admin'); hide('panel-dashboard-sales'); hide('panel-winners'); hide('panel-collections'); hide('panel-users'); hide('panel-settings'); hide('panel-shows');
      var nav=document.getElementById('navList'); if(nav) nav.innerHTML='';
      show('loginOverlay');
    };
  }

  // Login submit
  var lf = document.getElementById('loginForm');
  if(lf){
    lf.onsubmit = function(e){
      e.preventDefault();
      var email = (document.getElementById('loginEmail').value||'').trim().toLowerCase();
      var pw = (document.getElementById('loginPassword').value||'').trim();
      var err = document.getElementById('loginError'); err.classList.add('hidden'); err.textContent='';
      var usersRaw = localStorage.getItem('ga_users'); var users = []; try{ users = JSON.parse(usersRaw||'[]'); }catch(e){ users=[]; }
      var u = users.find(function(x){ return (x.email||'').toLowerCase()===email; });
      if(!u){ err.textContent='User not found'; err.classList.remove('hidden'); return; }
      if(u.active===false){ err.textContent='User is disabled'; err.classList.remove('hidden'); return; }
      var ok = false;
      if(u.password && u.password===pw) ok=true;
      else if(u.tempPassword && u.tempPassword===pw){ ok=true; u.password=pw; u.tempPassword=null; localStorage.setItem('ga_users', JSON.stringify(users)); }
      if(!ok){ err.textContent='Invalid password'; err.classList.remove('hidden'); return; }

      // Apply session using existing app helpers if present
      if(typeof applySession === 'function'){ applySession({ email:u.email, name:u.name, role:u.role }); }
      hide('loginOverlay');
      if(btnSO) btnSO.style.display='inline-flex';
      if(typeof showPanel === 'function'){ showPanel(defaultLanding(u.role)); }
      if(typeof toast === 'function'){ toast('Signed in as '+(u.name||u.email)); }
    };
  }

  // On load: if session exists, continue, else show login
  try{
    var sess = null; try{ sess = JSON.parse(localStorage.getItem('ga_session')||'null'); }catch(e){}
    if(sess && sess.email){
      if(typeof applySession === 'function'){ applySession(sess); }
      if(btnSO) btnSO.style.display='inline-flex';
      if(typeof showPanel === 'function'){ showPanel(defaultLanding(sess.role)); }
    }else{
      show('loginOverlay');
    }
  }catch(e){
    show('loginOverlay');
  }
})();
</script>
"""
    # Insert before closing body
    html = html.replace('</body>', init_script + '\n</body>')

out_path = Path('/mnt/data/GO-ALIVE-MEDIA-Phase1.8.1-loginfix.html')
out_path.write_text(html, encoding='utf-8')
print("Saved:", out_path)
